version: "3.8"

# ─────────────────────────────────────────────────────────────────────────────
# docker-compose.staging.yml
# Déploiement STAGING — pré-production privée pour tests
#
# Utilisation:
#   docker-compose -f docker-compose.staging.yml up -d
#   docker-compose -f docker-compose.staging.yml ps
#   docker-compose -f docker-compose.staging.yml logs -f backend
#
# Notes:
# - NODE_ENV=staging (empêche accidental seeding)
# - Volumes persistants (volumes nommés)
# - Healthchecks activés
# - Logging centralisé optionnel
# ─────────────────────────────────────────────────────────────────────────────

services:
  # ── MongoDB (Staging) ──
  mongo:
    image: mongo:6
    container_name: orthoshop-mongo-staging
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-staging_admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-staging_password}
      MONGO_INITDB_DATABASE: orthopedic_shop_staging
    volumes:
      - mongo-data-staging:/data/db
      - mongo-logs-staging:/var/log/mongodb
    networks:
      - orthoshop-staging-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── Backend (Staging) ──
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: orthoshop-backend-staging
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      MONGO_URI: "mongodb://${MONGO_USER:-staging_admin}:${MONGO_PASSWORD:-staging_password}@mongo:27017/orthopedic_shop_staging?authSource=admin"
      JWT_SECRET: ${JWT_SECRET}
      PORT: 5000
      NODE_ENV: staging
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      # Mailtrap ou autre staging SMTP
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USER: ${MAIL_USER}
      MAIL_PASS: ${MAIL_PASS}
      MAIL_FROM: ${MAIL_FROM}
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - ./backend/logs:/app/logs
    networks:
      - orthoshop-staging-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ── Frontend (Staging) ──
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:5000/api}
    container_name: orthoshop-frontend-staging
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - orthoshop-staging-net

# ── Volumes Staging ──
volumes:
  mongo-data-staging:
    driver: local
  mongo-logs-staging:
    driver: local

# ── Network Staging ──
networks:
  orthoshop-staging-net:
    driver: bridge
