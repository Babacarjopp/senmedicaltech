version: "3.8"

# ─────────────────────────────────────────────────────────────────────────────
# docker-compose.prod.yml
# Déploiement PRODUCTION avec Nginx + TLS/HTTPS
#
# Utilisation:
#   1. Configurer les variables d'environnement production dans .env.production
#   2. docker-compose -f docker-compose.prod.yml up -d
#   3. Initialiser certificats Let's Encrypt (voir docs/HTTPS_SETUP.md)
#
# Infrastructure:
#   - Nginx (reverse proxy + SSL termination)
#   - Backend Express (API)
#   - Frontend React (SPA)
#   - MongoDB (persistant)
# ─────────────────────────────────────────────────────────────────────────────

services:
  # ── Nginx (Reverse Proxy + TLS) ──
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: orthoshop-nginx-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot-certs:/etc/letsencrypt:ro
      - certbot-webroot:/var/www/certbot:ro
    depends_on:
      - backend
      - frontend
    networks:
      - orthoshop-prod-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ── MongoDB (Production) ──
  mongo:
    image: mongo:6
    container_name: orthoshop-mongo-prod
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: orthopedic_shop
    volumes:
      - mongo-data-prod:/data/db
      - mongo-logs-prod:/var/log/mongodb
    networks:
      - orthoshop-prod-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── Backend (Production) ──
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: orthoshop-backend-prod
    restart: always
    ports:
      - "5000:5000"
    environment:
      MONGO_URI: "mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongo:27017/orthopedic_shop?authSource=admin"
      JWT_SECRET: ${JWT_SECRET}
      PORT: 5000
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      MAIL_PROVIDER: ${MAIL_PROVIDER}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USER: ${MAIL_USER}
      MAIL_PASS: ${MAIL_PASS}
      MAIL_FROM: ${MAIL_FROM}
      # Optionnel: Sentry, Datadog DSN
      # SENTRY_DSN: ${SENTRY_DSN}
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - ./backend/logs:/app/logs
    networks:
      - orthoshop-prod-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ── Frontend (Production) ──
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL}
    container_name: orthoshop-frontend-prod
    restart: always
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - orthoshop-prod-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

# ── Volumes Production ──
volumes:
  mongo-data-prod:
    driver: local
  mongo-logs-prod:
    driver: local
  certbot-certs:
    driver: local
  certbot-webroot:
    driver: local

# ── Network Production ──
networks:
  orthoshop-prod-net:
    driver: bridge
